# Working Memory

- **v0.96 Balance Update (Nov 26, 2025):** Implemented comprehensive balance changes based on 50 AI vs AI simulation analysis:
  - Fixed settler escort logic: reordered manageSettlerEscorts before moveSettlersAndFound, enhanced assessSettlerSafety to check ALL enemy military within 4 tiles (not just war enemies), require escorts to be adjacent (distance 1), settlers wait for escorts in high threat.
  - Nerfed ScholarKingdoms: Changed +1 Science bonus threshold from Pop ≥3 to Pop ≥5.
  - Added AetherianVanguard passive "Battle Hardened": +1 HP to military units per era researched (max +3).
  - Added JadeCovenant passive "Bountiful Harvest": Cities start with +5 stored Food when founded.
  - Increased smaller map sizes: Tiny (14×10), Small (18×14), Standard (22×16) to reduce stalls.
  - Moved Army Doctrine from Engine era to Banner era (cost 50, prereq FormationTraining) for earlier army access.
  - Added AI razing logic: considerRazing() evaluates isolated/threatened/low-value cities for strategic razing.
  - Improved AI army formation priority: prioritizes Form Army when 2+ base units available, even in peacetime.
  - Updated GAME_VERSION to "0.96".

- Added river generation (RiverEdge overlays) in engine and client map generation; marked the river gap as completed in docs/doc_drift_report.md.
- Implemented city territory claim (radius 2, no-sharing) and auto tile working with multi-growth support; marked corresponding drift items as done.
- Added city capture/raze flow and fortify/heal behavior in engine and client; city ranged attack implemented via CityAttack action.
- Implemented tech passives (FormationTraining/DrilledRanks/SignalRelay) and progress project bonuses; Form Army now validates base units and transforms them on completion.
- Implemented end-of-round victory (progress/conquest) checks and elimination sweep (removes units) in engine/client.
- UI parity: build menus now show all units/buildings/projects; city ranged/raze exposed; manual worked-tile selection and diplomacy toggles added; fog-of-war rendering respects per-player visibility/reveal and is surfaced via a legend.
- Added fog shroud rendering with toggleable unseen hexes (question-mark shroud, tinted fog that preserves terrain hue) so unexplored areas are indicated instead of blank voids.
- Added shared-vision diplomacy pact: peace-time offers/accept/revoke wired through actions/UI; vision is merged while active and breaks automatically on war.
- Fixed city attack bug: handleTileClick in App.tsx now checks for enemy cities and triggers Attack action with targetType: "City" when unit is in range, preventing "Can only move 1 tile at a time" error for ranged units attacking cities. Also added line-of-sight check for city attacks in client turn-loop to match engine behavior.
- Remaining gaps: deeper diplomacy beyond war/peace/vision sharing; tile assignment could still use richer visual cues.
- When a drift item is completed, mark it in docs/doc_drift_report.md.
- Wired a `unitImages` asset map in the client, swapped unit circles for Settler PNG sprites, and staged a placeholder Settler image plus slot comments for future asset expansion.
- Rivers now use the `map.rivers` edge graph with helpers for adjacency; generator biases rivers downhill toward coasts using elevation/water-distance heuristics, and the client renders connected river segments instead of per-tile dots (overlay fallback kept for legacy saves).
- Rivers must be solved in the engine; client-side reconstruction attempts are unreliable. Always emit final river geometry from engine outputs.
- Implemented Unit Linking: optional `linkedUnitId` on units, new Link/Unlink actions, slower-unit pacing with auto-unlink when separated, UI controls + chain icon/highlight, and coverage tests to keep engine/client behavior aligned.
- Added Phase 0 regression coverage for the turn loop refactor: documented inventory of action behaviors, plus vitest specs that lock linked stack moves/unlinks, city ranged attack LOS/min-damage clamps, and shared-vision offer acceptance/war revocation ahead of splitting the monolith.
- Started Phase 1 of the turn-loop refactor by grouping existing helpers into exported `movement`, `combat`, and `cities` namespaces inside the engine loop so the client can later import the shared logic.
- Phase 2 file split complete: `turn-loop.ts` now just dispatches actions/tech selection while new modules (`game/actions/*`, `turn-lifecycle.ts`, `vision.ts`, `helpers/*`) host the previous 1.3k-line logic; npm test -w engine stayed green after the move.
- Phase 3 client integration: `client/src/utils/turn-loop.ts` was removed, `App.tsx` now imports `applyAction` from `@simple-civ/engine`, and docs/codebase_info were updated to reflect the single source of truth.
- Phase 4 cleanup: removed the old helper namespace exports from `engine/src/game/turn-loop.ts`, annotated historical docs/changelogs to mark `client/src/utils/turn-loop.ts` as legacy, and refreshed client/engine doc pages + drift reports to reference the shared engine entry point.
- Map generator guardrails: added deterministic regressions in `engine/src/map/map-generator.test.ts` for river polylines (seed 1337), start-site spacing/food guarantees, and overlay counts per terrain before touching the generator layout.
- Kicked off the map-generator refactor by extracting the terrain noise/overlay logic into `engine/src/map/generation/terrain.ts`, moving RNG/seed helpers into `engine/src/map/generation/seeding.ts`, centralizing start-site selection in `engine/src/map/generation/starts.ts`, and peeling river carving/polylines into `engine/src/map/generation/rivers.ts`; `generateWorld` now orchestrates these helpers and Vitest stays green.
- Client now consumes `@simple-civ/engine/generateWorld` directly; `client/src/utils/map-generator.ts` is gone and docs/codebase info reflect the single source of truth.
- Finished the Phase 3 cleanup: deleted the remaining client-only shims (`src/utils/{engine-types,constants,rules,ai*.ts}`), updated App/HUD/TechTree to import types/constants/rules/AI straight from the engine, and refreshed docs/testing notes accordingly.
- Completed the AI refactor through Phase 4: added regression tests for goal/tech/city/unit/diplomacy flows, split logic into `game/ai/{goals,tech,cities,city-heuristics,units,diplomacy}` with shared helpers (`ai/shared/{actions,metrics}`) plus a new `ai/turn-runner.ts`, leaving `ai.ts` as a thin `runAiTurn` facade and updating engine docs to describe the new layout.
- Map interaction now eases pan/zoom via `useMapInteraction` (wheel smoothing, cursor-anchored zoom, inertial drag) with shared constants in `client/src/components/GameMap/constants.ts` to keep the UX consistent.
- Added two new civilizations with unique end-game payoffs (no passive bonuses):
  - **Starborne Seekers** (teal #14b8a6): Can build Spirit Observatory (Engine era, Star Charts, 200 Prod) which triggers The Revelation — completes current tech, grants one free auto-selected tech, +2 Science per city permanently, and counts as Observatory milestone for Progress chain.
  - **Jade Covenant** (gold #eab308): Can build Jade Granary (Banner era, Wellworks, 150 Prod) which triggers The Great Harvest — +1 Pop to all cities, 15% cheaper growth permanently (stacks with Farmstead), +1 Food per city permanently.
  - Both wonders are consumed on completion (not added to buildings), similar to Titan's Core. Added city name lists (20 each), building data, civ-specific canBuild restrictions, and completion effects in turn-lifecycle.ts.
