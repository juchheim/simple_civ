# Working Memory

- **v0.98 Update 6 - War Completion & Civ Identity (Nov 27, 2025):** Fixing wars ending at exactly 15 turns and civ balance:
  - **CRITICAL: War Completion Logic** — Wars now last 25 turns (not 15) when winning. Added `hasCityAdvantage()`, `isWinningWar()`, `isActuallyLosingWar()` checks. Never peace if any advantage exists.
  - **ForgeClans "Industrial Warfare"** — +1 Attack per Engine-era tech (max +5). Fully teched ForgeClans get +5 Attack bonus! AI waits longer to declare (declareAfterContactTurns 4).
  - **StarborneSeekers NERFED** — Spirit Observatory cost 200→275 (+37.5%). Removed +1 Science in Capital from Stargazers (keep Sacred Site bonus only).
  - **FormArmy_Riders** — Cost 15→10 (0 formations in 50 games was unacceptable).

- **v0.98 Update 5 - Major Balance & War Finish Logic (Nov 27, 2025):** Comprehensive balance pass addressing win rate imbalances and stalled games:
  - **JadeCovenant NERFED**: Population Power threshold increased from 5 to 8 (bonus reduced from +10/+10 to +6/+6 at avg pop)
  - **ForgeClans MAJOR REWORK**: 
    - "Forged Arms" — +1 Attack when any city has 2+ worked Hills
    - "Production Mastery" — Military units cost 20% less
    - AI personality: warPowerThreshold 0.45→0.65 (less suicidal)
  - **StarborneSeekers BUFF**: "Celestial Guidance" — Units within 3 tiles of capital gain +1 Defense
  - **Form Army Costs Reduced**: SpearGuard/BowGuard 15→10, Riders 20→15
  - **WAR FINISH LOGIC (Critical Fix)**:
    - Overwhelming power (2x) or finishable target (1-2 cities, 1.5x power) bypasses peace duration
    - Never accept/propose peace when winning decisively
    - Fixes stalled games where dominant civs got stuck in peace/war cycles

- **v0.98 Update 4 - Civ Balance & AI Aggression (Nov 27, 2025):** Based on 50-game analysis showing ForgeClans 8.8% win rate, StarborneSeekers 17.6% win rate with 32.4% elimination, 8% stalled games:
  - **ForgeClans BUFF**: Added "Master Craftsmen" — Projects complete 25% faster (effective +25% production towards projects). Helps convert strong economy into victories.
  - **StarborneSeekers BUFF**: Changed starting bonus from 2 Scouts to Scout + SpearGuard. Addresses highest elimination rate by providing defensive capability.
  - **AI Overwhelming Power**: When a civ has 2x military power over ALL remaining enemies, AI switches to Conquest mode. Addresses stalled games.
  - **AI "Finish Him"**: AI now prioritizes attacking enemies down to 1-2 cities when AI has 1.5x their power. Siege targeting: Finishable → Capitals → Low HP → Nearest.
  - **Settler HP**: Set to 1 for balance testing (was 10).

- **v0.98 Update 3 - Settler Survival & Combat Balance (Nov 27, 2025):** Addressed 98.8% settler death rate:
  - **Settler HP increased from 5 to 10, added 2 Defense**: Settlers can now survive 2-3 attacks to escape
  - **AetherianVanguard now starts with TWO SpearGuards**: They were being attacked 3x more than they initiated (bullied)
  - **AI no longer attacks units during peacetime**: Only attacks war enemies now, significantly reducing settler deaths
  - **AI de-prioritizes settlers**: Now focuses on military threats first instead of hunting settlers

- **v0.98 Update 2 - Simulation Fix & Rebalance (Nov 27, 2025):** Fixed major simulation bias and adjusted civ balance:
  - **CRITICAL FIX: Civ Selection Randomization** — All simulation files now use seeded random shuffle for civ selection. Previously civs were picked in fixed order (ForgeClans always first, JadeCovenant only on Large/Huge maps), biasing all analysis data.
  - **JadeCovenant NERF**: Removed extra Settler start — 80% win rate with 17.6 avg cities was way too strong. They keep Population Power (+1 atk/def per 5 pop) and growth bonuses.
  - **StarborneSeekers MAJOR BUFF**: 0% win rate needed fixing:
    - NEW: Starts with extra Scout (3 units: Settler, 2x Scout) for faster exploration
    - NEW: "Stargazers" passive — +1 Science in Capital, +1 bonus Science from worked Sacred Sites
  - Files updated: `engine/src/sim/comprehensive-analysis.ts`, `engine/src/sim/ai-autoplay.ts`, `engine/src/sim/city-growth-analysis.ts`, `engine/src/map/map-generator.ts`, `engine/src/game/rules.ts`

- **v0.98 MAJOR Civ Rebalance (Nov 27, 2025):** Comprehensive civilization rework based on 50-game AI simulation showing ScholarKingdoms 54% win rate and AetherianVanguard/JadeCovenant 0% win rate:
  - **ScholarKingdoms MAJOR NERF**: Changed from "+2 Science in Capital" to "+1 Science per Scriptorium/Academy" — gates their bonus behind building investment (40-60 Prod each), no longer free snowball science.
  - **AetherianVanguard MAJOR BUFF**: 
    - NEW: Starts with extra SpearGuard (3 units: Settler, Scout, SpearGuard)
    - Titan's Core cost reduced from 200 to 150 (25% cheaper)
  - **RiverLeague BUFF**: Added "River Knowledge" — +1 Science in river cities (triple river bonus: +1F, +1P, +1S)
  - **ForgeClans FIX**: Now correctly gives +1 Production PER worked Hill tile (was only +1 total)
  - **Progress Victory Slowdown**: Project costs increased significantly:
    - Observatory: 160 (was 120, +33%)
    - Grand Academy: 210 (was 165, +27%)
    - Grand Experiment: 280 (was 210, +33%)
  - Updated GAME_VERSION to "0.98"
  - Created docs/rules/simple-civ_v0.98_rulebook.md with all balance changes documented.

- **v0.97 Major Balance Update (Nov 27, 2025):** Major rebalancing based on analysis showing 92.5% settler death rate and civ win rate imbalances:
  - **Settler HP increased from 1 to 5**: Settlers now survive at least one attack instead of instant death.
  - **AI Escort Linking**: AI now uses the LinkUnits action to link military escorts to settlers. Linked pairs move together and can't be separated. Escorts move to settler's tile first before linking.
  - **Proactive Settler Fleeing**: Settlers now flee from ANY nearby foreign military unit (not just war enemies) within 3 tiles. They also wait for escorts before moving into dangerous areas.
  - **ScholarKingdoms Nerf**: Changed from "+1 Science per city at Pop≥5" to "+2 Science in Capital only". Removes the scaling snowball effect while maintaining a strong early bonus.
  - **JadeCovenant Buff**: Added "Verdant Growth" passive — +10% faster growth globally (JADE_COVENANT_GROWTH_MULT = 0.9). Stacks with Farmstead (0.9) and Jade Granary (0.85) for maximum 31% faster growth.
  - **RiverLeague Buff**: Added "River Commerce" passive — +1 Production in cities on river tiles. Combined with +1 Food per river-adjacent tile, this makes rivers extremely valuable.
  - **Titan's Wrath (AetherianVanguard)**: When a Titan is spawned, AetherianVanguard automatically switches to Conquest mode. Added `titanRampage()` function that makes the Titan aggressively seek out and capture enemy cities, prioritizing capitals. The Titan uses its high movement and attack stats to crush anything in its path.
  - Updated GAME_VERSION to "0.97".
  - Created docs/rules/simple-civ_v0.97_rulebook.md with all balance changes documented.

- **v0.96 Balance Update (Nov 26, 2025):** Implemented comprehensive balance changes based on 50 AI vs AI simulation analysis:
  - Fixed settler escort logic: reordered manageSettlerEscorts before moveSettlersAndFound, enhanced assessSettlerSafety to check ALL enemy military within 4 tiles (not just war enemies), require escorts to be adjacent (distance 1), settlers wait for escorts in high threat.
  - Nerfed ScholarKingdoms: Changed +1 Science bonus threshold from Pop ≥3 to Pop ≥5.
  - Added AetherianVanguard passive "Battle Hardened": +1 HP to military units per era researched (max +3).
  - Added JadeCovenant passive "Bountiful Harvest": Cities start with +5 stored Food when founded.
  - Increased smaller map sizes: Tiny (14×10), Small (18×14), Standard (22×16) to reduce stalls.
  - Moved Army Doctrine from Engine era to Banner era (cost 50, prereq FormationTraining) for earlier army access.
  - Added AI razing logic: considerRazing() evaluates isolated/threatened/low-value cities for strategic razing.
  - Improved AI army formation priority: prioritizes Form Army when 2+ base units available, even in peacetime.
  - Updated GAME_VERSION to "0.96".

- Added river generation (RiverEdge overlays) in engine and client map generation; marked the river gap as completed in docs/doc_drift_report.md.
- Implemented city territory claim (radius 2, no-sharing) and auto tile working with multi-growth support; marked corresponding drift items as done.
- Added city capture/raze flow and fortify/heal behavior in engine and client; city ranged attack implemented via CityAttack action.
- Implemented tech passives (FormationTraining/DrilledRanks/SignalRelay) and progress project bonuses; Form Army now validates base units and transforms them on completion.
- Implemented end-of-round victory (progress/conquest) checks and elimination sweep (removes units) in engine/client.
- UI parity: build menus now show all units/buildings/projects; city ranged/raze exposed; manual worked-tile selection and diplomacy toggles added; fog-of-war rendering respects per-player visibility/reveal and is surfaced via a legend.
- Added fog shroud rendering with toggleable unseen hexes (question-mark shroud, tinted fog that preserves terrain hue) so unexplored areas are indicated instead of blank voids.
- Added shared-vision diplomacy pact: peace-time offers/accept/revoke wired through actions/UI; vision is merged while active and breaks automatically on war.
- Fixed city attack bug: handleTileClick in App.tsx now checks for enemy cities and triggers Attack action with targetType: "City" when unit is in range, preventing "Can only move 1 tile at a time" error for ranged units attacking cities. Also added line-of-sight check for city attacks in client turn-loop to match engine behavior.
- Remaining gaps: deeper diplomacy beyond war/peace/vision sharing; tile assignment could still use richer visual cues.
- When a drift item is completed, mark it in docs/doc_drift_report.md.
- Wired a `unitImages` asset map in the client, swapped unit circles for Settler PNG sprites, and staged a placeholder Settler image plus slot comments for future asset expansion.
- Rivers now use the `map.rivers` edge graph with helpers for adjacency; generator biases rivers downhill toward coasts using elevation/water-distance heuristics, and the client renders connected river segments instead of per-tile dots (overlay fallback kept for legacy saves).
- Rivers must be solved in the engine; client-side reconstruction attempts are unreliable. Always emit final river geometry from engine outputs.
- Implemented Unit Linking: optional `linkedUnitId` on units, new Link/Unlink actions, slower-unit pacing with auto-unlink when separated, UI controls + chain icon/highlight, and coverage tests to keep engine/client behavior aligned.
- Added Phase 0 regression coverage for the turn loop refactor: documented inventory of action behaviors, plus vitest specs that lock linked stack moves/unlinks, city ranged attack LOS/min-damage clamps, and shared-vision offer acceptance/war revocation ahead of splitting the monolith.
- Started Phase 1 of the turn-loop refactor by grouping existing helpers into exported `movement`, `combat`, and `cities` namespaces inside the engine loop so the client can later import the shared logic.
- Phase 2 file split complete: `turn-loop.ts` now just dispatches actions/tech selection while new modules (`game/actions/*`, `turn-lifecycle.ts`, `vision.ts`, `helpers/*`) host the previous 1.3k-line logic; npm test -w engine stayed green after the move.
- Phase 3 client integration: `client/src/utils/turn-loop.ts` was removed, `App.tsx` now imports `applyAction` from `@simple-civ/engine`, and docs/codebase_info were updated to reflect the single source of truth.
- Phase 4 cleanup: removed the old helper namespace exports from `engine/src/game/turn-loop.ts`, annotated historical docs/changelogs to mark `client/src/utils/turn-loop.ts` as legacy, and refreshed client/engine doc pages + drift reports to reference the shared engine entry point.
- Map generator guardrails: added deterministic regressions in `engine/src/map/map-generator.test.ts` for river polylines (seed 1337), start-site spacing/food guarantees, and overlay counts per terrain before touching the generator layout.
- Kicked off the map-generator refactor by extracting the terrain noise/overlay logic into `engine/src/map/generation/terrain.ts`, moving RNG/seed helpers into `engine/src/map/generation/seeding.ts`, centralizing start-site selection in `engine/src/map/generation/starts.ts`, and peeling river carving/polylines into `engine/src/map/generation/rivers.ts`; `generateWorld` now orchestrates these helpers and Vitest stays green.
- Client now consumes `@simple-civ/engine/generateWorld` directly; `client/src/utils/map-generator.ts` is gone and docs/codebase info reflect the single source of truth.
- Finished the Phase 3 cleanup: deleted the remaining client-only shims (`src/utils/{engine-types,constants,rules,ai*.ts}`), updated App/HUD/TechTree to import types/constants/rules/AI straight from the engine, and refreshed docs/testing notes accordingly.
- Completed the AI refactor through Phase 4: added regression tests for goal/tech/city/unit/diplomacy flows, split logic into `game/ai/{goals,tech,cities,city-heuristics,units,diplomacy}` with shared helpers (`ai/shared/{actions,metrics}`) plus a new `ai/turn-runner.ts`, leaving `ai.ts` as a thin `runAiTurn` facade and updating engine docs to describe the new layout.
- Map interaction now eases pan/zoom via `useMapInteraction` (wheel smoothing, cursor-anchored zoom, inertial drag) with shared constants in `client/src/components/GameMap/constants.ts` to keep the UX consistent.
- Added two new civilizations with unique end-game payoffs (no passive bonuses):
  - **Starborne Seekers** (teal #14b8a6): Can build Spirit Observatory (Engine era, Star Charts, 200 Prod) which triggers The Revelation — completes current tech, grants one free auto-selected tech, +2 Science per city permanently, and counts as Observatory milestone for Progress chain.
  - **Jade Covenant** (gold #eab308): Can build Jade Granary (Banner era, Wellworks, 150 Prod) which triggers The Great Harvest — +1 Pop to all cities, 15% cheaper growth permanently (stacks with Farmstead), +1 Food per city permanently.
  - Both wonders are consumed on completion (not added to buildings), similar to Titan's Core. Added city name lists (20 each), building data, civ-specific canBuild restrictions, and completion effects in turn-lifecycle.ts.
