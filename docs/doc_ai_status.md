# AI Status

## Documented behavior
- Rulebook AI / Engine Hooks (docs/rules/simple-civ_v0.9_rulebook.md:944-973): city-site scoring = center yield + best 3 nearby tiles with +1 river bonus and +1 per nearby overlay; tile working priority depends on Progress vs Conquest vs behind-curve Food bias; war/peace heuristic (declare if enemy city within ~8 tiles and power ≥ defender, accept peace when losing or Progress risk); victory pursuit switches after Observatory or if enemy capital is in strike range with Armies.
- Dev-spec aiHeuristics (docs/dev-spec/v0.9/aiHeuristics.ts.md): `scoreCitySite` and `tileWorkingPriority` functions matching the rulebook weights/bonuses with explicit Balanced fallback.
- Dev-spec aiDecisions (docs/dev-spec/v0.9/aiDecisions.ts.md): `aiChooseTech` (Progress path to StarCharts, Conquest path to DrilledRanks/ArmyDoctrine, else cheapest useful), `aiWarPeaceDecision` (same war/peace heuristic as rulebook), and `aiVictoryBias` (Observatory => Progress, strike-range capital + Armies => Conquest, else Balanced).
- Dev-spec placeStarts (docs/dev-spec/v0.9/placeStarts.ts.md:6) expects start-site scoring to reuse the AI city-site scoring heuristic.
- Internal documentation (docs/IMPLEMENTATION_STATUS.md, docs/doc_drift_report*.md) already flags AI heuristics/personality as missing and notes the doc-locked modules `aiHeuristics.ts.md` and `aiDecisions.ts.md` are absent.

## Implemented in code
- AI heuristics and decision helpers implemented per docs:
  - `scoreCitySite` / `tileWorkingPriority` now exist in both engine and client (`engine/src/game/ai-heuristics.ts`, `client/src/utils/ai-heuristics.ts`) and match the rulebook weights/bonuses (center + best3 + river + overlay bonus, Progress vs Conquest tile priorities, food bias when behind curve).
  - Decision helpers (`aiVictoryBias`, `aiChooseTech`, `aiWarPeaceDecision`) implemented (`engine/src/game/ai-decisions.ts`, `client/src/utils/ai-decisions.ts`) following the doc heuristics for tech paths, war/peace triggers, and victory-goal switching.
- The AI turn loops now use those helpers (`client/src/utils/ai.ts` wraps `engine/src/game/ai.ts` so both client/engine share the same executor):
  - Chooses tech based on the current victory bias (Progress path to StarCharts, Conquest path to DrilledRanks/ArmyDoctrine, else cheapest available).
  - Sets city builds with bias-aware priorities (science projects/buildings for Progress, military/form-army projects for Conquest, settlers + basics for Balanced).
  - Assigns worked tiles using the doc tile-working priority per city, with a food catch-up bias when pop lags.
  - Settler automation: moves toward the best nearby city sites (using `scoreCitySite`) and founds cities; names are autogenerated.
  - Diplomacy automation: declares war when an enemy city is within 8 tiles and AI power ≥ defender; proposes/accepts peace if losing or Progress race risk is high.
  - Military micro: attacks nearby cities/units, then advances toward war targets; captures adjacent 0-HP cities; war power now weights attack/defense heavier and gives armies extra weight.
  - Stores the AI victory goal on the player (`aiGoal`) so bias is visible/persisted.
- Start placement now uses the documented city-site scoring heuristic instead of the prior ad-hoc formula in both map generators (`engine/src/map/map-generator.ts`, `client/src/utils/map-generator.ts`).
- AI turn autoskip loop remains in the client (`client/src/App.tsx:107-121`) and drives the new behavior for `isAI` players.
- Tests cover the AI heuristics/decisions/executor to lock doc rules (`engine/src/game/ai.test.ts`, `engine/src/game/ai.e2e.test.ts`), and the client relies on the engine AI (`client/src/utils/ai.ts` wrapper; client has a wrapper test in `client/src/utils/ai.test.ts` but no client test runner is wired yet—only the engine Vitest suite runs via `npm test`).
- Fog is refreshed immediately after a unit moves via `refreshPlayerVision`, so revealed tiles show up as soon as movement finishes rather than waiting for end-of-turn.

## Gaps vs docs
- Remaining approximations to tighten:
  - Military power is still heuristic (weighted atk/def/hp + city defense); tune weights as needed.
  - Progress-race risk uses opponent Progress milestones and active research toward StarCharts path; add more signals if desired.
  - Combat micro is greedy (attack if in range, march toward nearest war target); tactical movement/target selection could be improved but the core doc hooks are now present.

## Steps to reach doc compliance
- All doc requirements under (1)-(4) are now implemented: shared heuristics/decisions, bias-aware engine executor, and targeted tests have been added.
