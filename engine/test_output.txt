
> @simple-civ/engine@1.0.0 test
> vitest run


 RUN  v1.6.1 /Users/ejuchheim/Projects/Simple-Civ/SimpleCiv/engine

 ✓ src/map/generation/landmass.test.ts  (10 tests) 18ms
 ✓ src/map/rivers-polylines.snap.test.ts  (3 tests) 71ms
 ✓ src/game/city_visibility_repro.test.ts  (4 tests) 9ms
 ✓ src/game/garrison.test.ts  (6 tests) 8ms
 ✓ src/game/city-combat.test.ts  (6 tests) 13ms
 ✓ src/game/found_city_validation.test.ts  (7 tests) 10ms
 ✓ src/game/ai/units/tactics.test.ts  (7 tests) 16ms
 ✓ src/game/ai/war-prep.test.ts  (9 tests) 18ms
 ✓ src/game/post-attack-movement.test.ts  (2 tests) 24ms
 ✓ src/game/filler_projects.test.ts  (5 tests) 17ms
 ❯ src/game/ai.test.ts  (23 tests | 1 failed) 264ms
   ❯ src/game/ai.test.ts > ai personality behaviors > AetherianVanguard prioritizes Titan rush path over Conquest path
     → expected 'ScriptLore' to be 'DrilledRanks' // Object.is equality
 ✓ src/game/garrison_attack_uncaptured_city.test.ts  (3 tests) 6ms
 ✓ src/game/bug_fixes.test.ts  (3 tests) 8ms
 ✓ src/game/repro_retaliation.test.ts  (3 tests) 7ms
stdout | src/game/ai.rules-compliance.test.ts > ai rules compliance > keeps AI actions within movement/stacking/terrain rules over multiple turns
Turn 1: afterP1=true, afterP2=true
Turn 2: afterP1=true, afterP2=true
Turn 3: afterP1=false, afterP2=false

 ✓ src/game/ai.rules-compliance.test.ts  (1 test) 875ms
 ✓ src/game/ai/units/ranged-threat-awareness.test.ts  (3 tests) 209ms
 ✓ src/game/worked-tiles-optimization.test.ts  (3 tests) 19ms
 ✓ src/game/balance/balance_round_2.test.ts  (4 tests) 10ms
 ✓ src/game/ai/swap_units.test.ts  (4 tests) 29ms
 ✓ src/game/helpers/action-helpers.test.ts  (6 tests) 7ms
 ✓ src/game/ai.behavior.test.ts  (5 tests) 23ms
 ✓ src/game/era_advancement.test.ts  (4 tests) 8ms
 ✓ src/game/unique_city_names.test.ts  (4 tests) 8ms
 ✓ src/game/army-advance.test.ts  (3 tests) 9ms
 ✓ src/game/city_capture_garrison.test.ts  (2 tests) 7ms
 ✓ src/game/natures_wrath.test.ts  (3 tests) 2478ms
 ✓ src/game/goodie-huts.test.ts  (6 tests) 6ms
 ✓ src/game/expel-units.test.ts  (2 tests) 4ms
 ❯ src/game/bowguard_settler_capture.test.ts  (2 tests | 2 failed) 60ms
   ❯ src/game/bowguard_settler_capture.test.ts > Bowguard Settler Capture in City > should NOT capture Settler in enemy city (redirects to city damage) for Bowguard
     → expected 16 to be 15 // Object.is equality
   ❯ src/game/bowguard_settler_capture.test.ts > Bowguard Settler Capture in City > should NOT capture Settler in enemy city (redirects to city damage) for SpearGuard
     → expected 16 to be 15 // Object.is equality
 ✓ src/game/turn-loop.test.ts  (10 tests) 4943ms
 ✓ src/game/balance/bulwark_production.test.ts  (8 tests) 70ms
 ✓ src/game/ai/unit-production.test.ts  (3 tests) 6ms
 ✓ src/game/unit-linking.test.ts  (4 tests) 6ms
 ✓ src/map/rivers-selection.test.ts  (3 tests) 7ms
 ✓ src/game/auto_explore.test.ts  (6 tests) 1904ms
 ✓ src/game/balance/nerfs.test.ts  (5 tests) 5ms
 ✓ src/game/balance.test.ts  (9 tests) 5ms
 ✓ src/game/territory-growth.test.ts  (2 tests) 7ms
 ✓ src/game/production_switching.test.ts  (2 tests) 3ms
 ✓ src/game/pathing_fixes.test.ts  (2 tests) 725ms
 ✓ src/game/ai.e2e.test.ts  (2 tests) 74ms
 ✓ src/game/helpers/spawn.test.ts  (3 tests) 4ms
 ✓ src/map/rivers-metrics.snap.test.ts  (1 test) 211ms
 ✓ src/map/generation/noise.test.ts  (11 tests) 189ms
 ✓ src/map/rivers-helpers.test.ts  (3 tests) 3ms
 ✓ src/game/research.test.ts  (3 tests) 5ms
 ✓ src/game/ai/units/titan.leash.test.ts  (4 tests) 3643ms
 ✓ src/game/ai2/behavior.test.ts  (2 tests) 30ms
 ❯ src/game/ai/siege.test.ts  (2 tests | 1 failed) 1554ms
   ❯ src/game/ai/siege.test.ts > AI Siege Logic > should move units through friendly units to reach target
     → expected { q: 5, r: 3 } to not deeply equal { q: 5, r: 3 }
 ✓ src/map/rivers-pathfinding.integration.test.ts  (1 test) 182ms
 ✓ src/game/movement.test.ts  (2 tests) 5ms
 ✓ src/game/bowguard_range_attack.test.ts  (1 test) 5ms
 ✓ src/game/repro_garrison_attack.test.ts  (1 test) 3ms
 ✓ src/game/repro_garrison_active_attack.test.ts  (1 test) 5ms
 ✓ src/game/rules.test.ts  (4 tests) 1505ms
 ✓ src/game/cost_scaling.test.ts  (6 tests) 3ms
 ✓ src/game/auto_explore_efficiency.test.ts  (2 tests) 3ms
 ✓ src/game/natives/native-behavior.test.ts  (2 tests) 4ms
 ✓ src/game/repro_fortify_bug.test.ts  (1 test) 4ms
stdout | src/game/fog_movement.test.ts > Fog of War Movement > findPath should return a valid path to fogged tiles
Path found: [ { q: 1, r: 0 }, { q: 2, r: 0 }, { q: 3, r: 0 } ]

 ✓ src/game/fog_movement.test.ts  (1 test) 148ms
 ✓ src/game/actions/diplomacy_verification.test.ts  (1 test) 3ms
 ❯ src/game/titan_stats.test.ts  (2 tests | 1 failed) 10ms
   ❯ src/game/titan_stats.test.ts > Titan Stats & Mechanics > should have correct Titan stats (as defined in core/constants)
     → expected 6 to be 5 // Object.is equality
 ✓ src/map/rivers.test.ts  (4 tests) 3ms
 ✓ src/game/auto_move_debug.test.ts  (1 test) 327ms
 ✓ src/game/conquest-stall.test.ts  (2 tests) 3ms
 ✓ src/game/tech_requirements.test.ts  (2 tests) 3ms
 ✓ src/game/balance/army_size.test.ts  (2 tests) 2ms
 ✓ src/game/victory_type.test.ts  (2 tests) 21ms
 ✓ src/game/auto_explore_terrain.test.ts  (1 test) 262ms
 ✓ src/game/defeat_condition.test.ts  (1 test) 417ms
 ✓ src/map/map-generator.test.ts  (8 tests) 10551ms

⎯⎯⎯⎯⎯⎯⎯ Failed Tests 5 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/game/ai.test.ts > ai personality behaviors > AetherianVanguard prioritizes Titan rush path over Conquest path
AssertionError: expected 'ScriptLore' to be 'DrilledRanks' // Object.is equality

- Expected
+ Received

- DrilledRanks
+ ScriptLore

 ❯ src/game/ai.test.ts:868:23
    866|         state.players[0].techs = [TechId.FormationTraining, TechId.Sto…
    867|         const pick2 = aiChooseTech("p", state as any, "Conquest");
    868|         expect(pick2).toBe(TechId.DrilledRanks);
       |                       ^
    869| 
    870|         // After DrilledRanks, should pick TimberMills (Titan prereq)

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/5]⎯

 FAIL  src/game/bowguard_settler_capture.test.ts > Bowguard Settler Capture in City > should NOT capture Settler in enemy city (redirects to city damage) for Bowguard
AssertionError: expected 16 to be 15 // Object.is equality

- Expected
+ Received

- 15
+ 16

 ❯ src/game/bowguard_settler_capture.test.ts:104:31
    102|         expect(updatedBowguard?.coord).toEqual({ q: 0, r: 0 });
    103|         expect(updatedSettler?.ownerId).toBe('p2');
    104|         expect(cityAfter?.hp).toBe(15); // v2.0: Civ 6 formula deals 5…
       |                               ^
    105|     });
    106| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/5]⎯

 FAIL  src/game/bowguard_settler_capture.test.ts > Bowguard Settler Capture in City > should NOT capture Settler in enemy city (redirects to city damage) for SpearGuard
AssertionError: expected 16 to be 15 // Object.is equality

- Expected
+ Received

- 15
+ 16

 ❯ src/game/bowguard_settler_capture.test.ts:170:31
    168|         expect(updatedSpearguard?.coord).toEqual({ q: 0, r: 0 });
    169|         expect(updatedSettler?.ownerId).toBe('p2');
    170|         expect(cityAfter?.hp).toBe(15); // v2.0: Civ 6 formula deals 5…
       |                               ^
    171|     });
    172| });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/5]⎯

 FAIL  src/game/titan_stats.test.ts > Titan Stats & Mechanics > should have correct Titan stats (as defined in core/constants)
AssertionError: expected 6 to be 5 // Object.is equality

- Expected
+ Received

- 5
+ 6

 ❯ src/game/titan_stats.test.ts:11:27
      9|     it("should have correct Titan stats (as defined in core/constants)…
     10|         const titan = UNITS[UnitType.Titan];
     11|         expect(titan.def).toBe(5);
       |                           ^
     12|         expect(titan.hp).toBe(20);
     13|         expect(titan.atk).toBe(22);

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/5]⎯

 FAIL  src/game/ai/siege.test.ts > AI Siege Logic > should move units through friendly units to reach target
AssertionError: expected { q: 5, r: 3 } to not deeply equal { q: 5, r: 3 }

Compared values have no visual difference.

 ❯ src/game/ai/siege.test.ts:147:44
    145| 
    146|         const updatedAttacker = nextState.units.find(u => u.id === att…
    147|         expect(updatedAttacker?.coord).not.toEqual({ q: 5, r: 3 });
       |                                            ^
    148|     });
    149| });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/5]⎯

 Test Files  4 failed | 67 passed (71)
      Tests  5 failed | 271 passed (276)
   Start at  12:15:27
   Duration  11.97s (transform 5.96s, setup 3ms, collect 23.47s, tests 31.10s, environment 13ms, prepare 22.03s)

npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /Users/ejuchheim/Projects/Simple-Civ/SimpleCiv/engine
npm error workspace @simple-civ/engine@1.0.0
npm error location /Users/ejuchheim/Projects/Simple-Civ/SimpleCiv/engine
npm error command failed
npm error command sh -c vitest run
